---
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/blog/PostCard.astro';
import { getCollection } from 'astro:content';
import { sortByDate, filterDrafts, getReadingTime } from '@/lib/utils';
import { BLOG_CATEGORIES } from '@/lib/constants';

// Get all posts
const allPosts = await getCollection('blog');
const posts = sortByDate(filterDrafts(allPosts));

// Get category from query (for filtering)
const currentCategory = Astro.url.searchParams.get('category');
const filteredPosts = currentCategory 
  ? posts.filter((p) => p.data.category === currentCategory)
  : posts;
---

<BaseLayout
  title="Blog"
  description="Technical articles about procedural generation, technical art, tool development, and game development."
>
  <section class="section">
    <div class="container">
      <!-- Header -->
      <header class="mb-12" data-animate>
        <h1 class="heading-1 mb-4">Blog</h1>
        <p class="lead max-w-2xl">
          Technical deep-dives, tutorials, and thoughts on procedural generation, 
          technical art, and tool development.
        </p>
      </header>
      
      <!-- Category Filter -->
      <div class="mb-10 pb-6 border-b border-border overflow-x-auto no-scrollbar" data-animate>
        <div class="flex items-center gap-2 min-w-max">
          <button
            data-filter="all"
            class="filter-btn px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-accent text-white"
          >
            All
          </button>
          {BLOG_CATEGORIES.map((cat) => (
            <button
              data-filter={cat.slug}
              class="filter-btn px-4 py-2 text-sm font-medium rounded-lg transition-colors whitespace-nowrap text-text-secondary hover:text-text-primary hover:bg-bg-secondary"
            >
              {cat.label}
            </button>
          ))}
        </div>
      </div>
      
      <!-- Posts Grid -->
      {filteredPosts.length > 0 ? (
        <div id="posts-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {posts.map((post, index) => (
            <div data-animate style={`animation-delay: ${index * 50}ms`} data-category={post.data.category} class="post-item">
              <PostCard
                title={post.data.title}
                description={post.data.description}
                publishedAt={post.data.publishedAt}
                category={post.data.category}
                tags={post.data.tags}
                readingTime={8}
                href={`/blog/${post.slug}`}
                featured={post.data.featured}
              />
            </div>
          ))}
        </div>
      ) : (
        <div class="card text-center py-16">
          <div class="text-4xl mb-4">üìù</div>
          <h3 class="heading-4 mb-2">No articles yet</h3>
          <p class="text-text-tertiary">
            {currentCategory 
              ? `No articles in this category yet. Check back soon!`
              : `Articles are coming soon. Stay tuned!`
            }
          </p>
        </div>
      )}
    </div>
  </section>
  
  <script>
    const filterButtons = document.querySelectorAll('.filter-btn');
    const postItems = document.querySelectorAll('.post-item');
    
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const filter = button.getAttribute('data-filter');
        
        // Update button styles
        filterButtons.forEach(btn => {
          if (btn === button) {
            btn.classList.add('bg-accent', 'text-white');
            btn.classList.remove('text-text-secondary', 'hover:text-text-primary', 'hover:bg-bg-secondary');
          } else {
            btn.classList.remove('bg-accent', 'text-white');
            btn.classList.add('text-text-secondary', 'hover:text-text-primary', 'hover:bg-bg-secondary');
          }
        });
        
        // Filter posts
        postItems.forEach(item => {
          const category = item.getAttribute('data-category');
          if (filter === 'all' || category === filter) {
            (item as HTMLElement).style.display = 'block';
          } else {
            (item as HTMLElement).style.display = 'none';
          }
        });
      });
    });
  </script>
</BaseLayout>
